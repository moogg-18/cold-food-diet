<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ–°å¢ä¸‰é¤ç´€éŒ„</title>
  <link rel="stylesheet" href="style.css?v=132" />
</head>

<body>
  <header class="topbar">
    <h1>ğŸ± æ–°å¢ä¸‰é¤ç´€éŒ„</h1>
    <p class="sub"><a class="link" href="index.html">â† å›é¦–é </a></p>
  </header>

  <main class="container">

    <section class="panel" id="caloriePanel">
      <h2 id="statusTitle">ç†±é‡ç‹€æ…‹</h2>

      <div class="grid">
        <div class="metric">
          <div class="label">å»ºè­°æ”å–é‡</div>
          <div class="value" id="dailyLimit">â€”</div>
          <div class="hint">kcal</div>
        </div>

        <div class="metric">
          <div class="label">ç•¶æ—¥å·²æ”å–</div>
          <div class="value" id="dayTotal">0</div>
          <div class="hint">kcal</div>
        </div>
      </div>

      <p class="note" id="overWarn">è«‹å…ˆåˆ°ã€Œå€‹äººè¨­å®šã€å¡«å¯«è³‡æ–™ï¼Œç³»çµ±æ‰èƒ½è¨ˆç®—å»ºè­°ç†±é‡ã€‚</p>
    </section>

    <section class="panel">
      <h2>æ–°å¢ä¸€ç­†ç´€éŒ„</h2>

      <label class="small">æ—¥æœŸ</label>
      <input id="date" class="input" type="date" />

      <div style="height:10px"></div>

      <label class="small">é¤åˆ¥</label>
      <select id="meal" class="input">
        <option value="æ—©é¤">æ—©é¤</option>
        <option value="åˆé¤">åˆé¤</option>
        <option value="æ™šé¤">æ™šé¤</option>
        <option value="é»å¿ƒ">é»å¿ƒ</option>
      </select>

      <div style="height:10px"></div>

      <label class="small">é£Ÿç‰©åç¨±</label>
      <input id="food" class="input" placeholder="ä¾‹ï¼šå†°ç´…èŒ¶ / æ²™æ‹‰ / é›èƒ¸è‚‰" />

      <div style="height:10px"></div>

      <label class="small">ç†±é‡ï¼ˆkcalï¼‰</label>
      <input id="cal" class="input" type="number" placeholder="ä¾‹ï¼š350" />

      <div style="height:12px"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="btnAdd" type="button">æ–°å¢</button>
        <button class="btn btn-outline" id="btnReset" type="button">é‡æ–°è¼¸å…¥</button>
        <button class="btn btn-outline" id="btnPhoto" type="button">æ–°å¢ç…§ç‰‡</button>
      </div>

      <input type="file" id="photoInput" accept="image/*" style="display:none" />
      <p class="note" id="msg"></p>
    </section>

    <!-- âœ… æ–°å¢ï¼šä»Šæ—¥é£Ÿç‰©æ”å–ç´°é …ï¼ˆè¡¨æ ¼ï¼‰ -->
    <section class="panel food-detail-panel">
      <h2>ä»Šæ—¥é£Ÿç‰©æ”å–ç´°é …</h2>

      <div class="table-wrapper">
        <table class="food-table">
          <thead>
            <tr>
              <th>é¤åˆ¥</th>
              <th>é£Ÿç‰©åç¨±</th>
              <th>ç†±é‡ (kcal)</th>
              <th>æ˜¯å¦ç‚ºå†·æ€§é£Ÿç‰©</th>
            </tr>
          </thead>
          <tbody id="foodTableBody">
            <tr class="empty">
              <td colspan="4">å°šæœªæ–°å¢ä»»ä½•é£Ÿç‰©ç´€éŒ„</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="panel">
      <h2>å¿«æ·å…¥å£</h2>
      <a class="card" href="stats.html">ğŸ“Š çœ‹ä»Šæ—¥çµ±è¨ˆèˆ‡å»ºè­°</a>
      <a class="card" href="profile.html">ğŸ‘¤ å€‹äººè¨­å®š</a>
    </section>

  </main>

  <script src="app.js?v=132"></script>
  <script>
    const dateEl = document.getElementById("date");
    const meal = document.getElementById("meal");
    const food = document.getElementById("food");
    const cal = document.getElementById("cal");
    const msg = document.getElementById("msg");

    const statusTitle = document.getElementById("statusTitle");
    const dailyLimitEl = document.getElementById("dailyLimit");
    const dayTotalEl = document.getElementById("dayTotal");
    const overWarnEl = document.getElementById("overWarn");

    const btnAdd = document.getElementById("btnAdd");
    const btnReset = document.getElementById("btnReset");
    const btnPhoto = document.getElementById("btnPhoto");
    const photoInput = document.getElementById("photoInput");

    const foodTableBody = document.getElementById("foodTableBody");

    let selectedPhoto = null;

    // é è¨­æ—¥æœŸ = ä»Šå¤©
    dateEl.value = window.App.todayISO();

    function renderStatusBySelectedDate() {
      const d = dateEl.value || window.App.todayISO();
      const status = window.App.getStatusByDate(d);

      statusTitle.textContent = `ç†±é‡ç‹€æ…‹ï¼ˆ${d}ï¼‰`;
      dayTotalEl.textContent = status.total;

      if (!status.limit) {
        dailyLimitEl.textContent = "â€”";
        overWarnEl.textContent = "è«‹å…ˆåˆ°ã€Œå€‹äººè¨­å®šã€å¡«å¯«èº«é«˜ã€é«”é‡ã€å¹´é½¡ã€æ€§åˆ¥èˆ‡é‹å‹•é‡ï¼Œç³»çµ±æ‰èƒ½è¨ˆç®—å»ºè­°ç†±é‡ã€‚";
        overWarnEl.style.color = "#4d3900";
        overWarnEl.style.fontWeight = "600";
        return;
      }

      dailyLimitEl.textContent = status.limit;

      if (status.over) {
        overWarnEl.textContent = `âš  ${d} ç†±é‡å·²è¶…éå»ºè­°æ”å–é‡ï¼ˆ+${status.overBy} kcalï¼‰ï¼Œä»å¯ç¹¼çºŒæ–°å¢ç´€éŒ„ã€‚`;
        overWarnEl.style.color = "red";
        overWarnEl.style.fontWeight = "800";
      } else {
        overWarnEl.textContent = `âœ” ${d} ä»åœ¨å»ºè­°æ”å–ç¯„åœå…§`;
        overWarnEl.style.color = "#7a8f4e";
        overWarnEl.style.fontWeight = "800";
      }
    }

    // ====== âœ… ä»Šæ—¥é£Ÿç‰©ç´°é …è¡¨æ ¼æ¸²æŸ“ï¼ˆä¿åº•ç‰ˆï¼‰ ======
    function getLogsByDateSafe(d) {
      // 1) è‹¥ app.js æœ‰æä¾›
      if (window.App && typeof window.App.getLogsByDate === "function") {
        return window.App.getLogsByDate(d) || [];
      }

      // 2) æ²’æœ‰å°±å¾ localStorage å¸¸è¦‹ key å˜—è©¦
      const tryKeys = ["logs", "foodLogs", "mealLogs", "dietLogs"];
      for (const k of tryKeys) {
        const raw = localStorage.getItem(k);
        if (!raw) continue;

        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr)) {
            return arr.filter(x => (x.date || x.d || x.day) === d);
          }
        } catch (_) {}
      }
      return [];
    }

    function renderFoodTableBySelectedDate() {
      const d = dateEl.value || window.App.todayISO();
      const logs = getLogsByDateSafe(d);

      if (!logs || logs.length === 0) {
        foodTableBody.innerHTML = `
          <tr class="empty">
            <td colspan="4">å°šæœªæ–°å¢ä»»ä½•é£Ÿç‰©ç´€éŒ„</td>
          </tr>`;
        return;
      }

      foodTableBody.innerHTML = logs.map(item => {
        const mealText = item.meal || item.type || "â€”";
        const foodText = item.food || item.name || "â€”";
        const kcalText = item.cal || item.kcal || item.calories || "â€”";

        // å†·æ€§æ¬„ä½ï¼šå¦‚æœè³‡æ–™æœ¬èº«æœ‰ isCold å°±ç”¨ï¼›æ²’æœ‰å°±é¡¯ç¤ºæœªåˆ¤å®š
        const coldText =
          (item.isCold === true) ? "æ˜¯" :
          (item.isCold === false) ? "å¦" :
          "æœªåˆ¤å®š";

        return `
          <tr>
            <td>${mealText}</td>
            <td>${foodText}</td>
            <td>${kcalText}</td>
            <td>${coldText}</td>
          </tr>
        `;
      }).join("");
    }

    // åˆæ¬¡æ¸²æŸ“
    renderStatusBySelectedDate();
    renderFoodTableBySelectedDate();

    // âœ… æ—¥æœŸæ”¹è®Šå°±æ›´æ–°ï¼šç‹€æ…‹ + è¡¨æ ¼
    dateEl.addEventListener("change", () => {
      renderStatusBySelectedDate();
      renderFoodTableBySelectedDate();
    });

    // æ–°å¢ç…§ç‰‡
    btnPhoto.addEventListener("click", () => photoInput.click());

    photoInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        selectedPhoto = reader.result;
        msg.textContent = "ğŸ“¸ å·²é¸æ“‡ç…§ç‰‡ï¼ˆå°‡æ–¼æ–°å¢æ™‚ä¸€ä½µå„²å­˜ï¼‰";
      };
      reader.readAsDataURL(file);
    });

    // é‡æ–°è¼¸å…¥
    btnReset.addEventListener("click", () => {
      food.value = "";
      cal.value = "";
      selectedPhoto = null;
      photoInput.value = "";
      msg.textContent = "ğŸ”„ å·²æ¸…ç©ºæ¬„ä½";
    });

    // æ–°å¢
    btnAdd.addEventListener("click", () => {
      const d = dateEl.value;
      const f = food.value.trim();
      const c = cal.value;

      if (!d) { msg.textContent = "è«‹é¸æ“‡æ—¥æœŸ"; return; }
      if (!f) { msg.textContent = "è«‹è¼¸å…¥é£Ÿç‰©åç¨±"; return; }
      if (!c) { msg.textContent = "è«‹è¼¸å…¥ç†±é‡"; return; }

      window.App.addLog(meal.value, f, c, selectedPhoto, d);

      msg.textContent = selectedPhoto ? "âœ… å·²æ–°å¢ç´€éŒ„ï¼ˆå«ç…§ç‰‡ï¼‰" : "âœ… å·²æ–°å¢ç´€éŒ„";

      food.value = "";
      cal.value = "";
      selectedPhoto = null;
      photoInput.value = "";

      // æ–°å¢å¾Œï¼šæ›´æ–°è©²æ—¥æœŸç‹€æ…‹ + è¡¨æ ¼
      renderStatusBySelectedDate();
      renderFoodTableBySelectedDate();
    });
  </script>
</body>
</html>
