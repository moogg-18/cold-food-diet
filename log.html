<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新增三餐紀錄</title>
  <link rel="stylesheet" href="style.css?v=132" />
</head>

<body>
  <header class="topbar">
    <h1>🍱 新增三餐紀錄</h1>
    <p class="sub"><a class="link" href="index.html">← 回首頁</a></p>
  </header>

  <main class="container">

    <section class="panel" id="caloriePanel">
      <h2 id="statusTitle">熱量狀態</h2>

      <div class="grid">
        <div class="metric">
          <div class="label">建議攝取量</div>
          <div class="value" id="dailyLimit">—</div>
          <div class="hint">kcal</div>
        </div>

        <div class="metric">
          <div class="label">當日已攝取</div>
          <div class="value" id="dayTotal">0</div>
          <div class="hint">kcal</div>
        </div>
      </div>

      <p class="note" id="overWarn">請先到「個人設定」填寫資料，系統才能計算建議熱量。</p>
    </section>

    <section class="panel">
      <h2>新增一筆紀錄</h2>

      <label class="small">日期</label>
      <input id="date" class="input" type="date" />

      <div style="height:10px"></div>

      <label class="small">餐別</label>
      <select id="meal" class="input">
        <option value="早餐">早餐</option>
        <option value="午餐">午餐</option>
        <option value="晚餐">晚餐</option>
        <option value="點心">點心</option>
      </select>

      <div style="height:10px"></div>

      <label class="small">食物名稱</label>
      <input id="food" class="input" placeholder="例：冰紅茶 / 沙拉 / 雞胸肉" />

      <div style="height:10px"></div>

      <label class="small">熱量（kcal）</label>
      <input id="cal" class="input" type="number" placeholder="例：350" />

      <div style="height:12px"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="btnAdd" type="button">新增</button>
        <button class="btn btn-outline" id="btnReset" type="button">重新輸入</button>
        <button class="btn btn-outline" id="btnPhoto" type="button">新增照片</button>
      </div>

      <input type="file" id="photoInput" accept="image/*" style="display:none" />
      <p class="note" id="msg"></p>
    </section>

    <section class="panel">
      <h2>快捷入口</h2>
      <a class="card" href="stats.html">📊 看今日統計與建議</a>
      <a class="card" href="profile.html">👤 個人設定</a>
    </section>

  </main>

  <script src="app.js?v=132"></script>
  <script>
    const dateEl = document.getElementById("date");
    const meal = document.getElementById("meal");
    const food = document.getElementById("food");
    const cal = document.getElementById("cal");
    const msg = document.getElementById("msg");

    const statusTitle = document.getElementById("statusTitle");
    const dailyLimitEl = document.getElementById("dailyLimit");
    const dayTotalEl = document.getElementById("dayTotal");
    const overWarnEl = document.getElementById("overWarn");

    const btnAdd = document.getElementById("btnAdd");
    const btnReset = document.getElementById("btnReset");
    const btnPhoto = document.getElementById("btnPhoto");
    const photoInput = document.getElementById("photoInput");

    let selectedPhoto = null;

    // 預設日期 = 今天
    dateEl.value = window.App.todayISO();

    function renderStatusBySelectedDate() {
      const d = dateEl.value || window.App.todayISO();
      const status = window.App.getStatusByDate(d);

      statusTitle.textContent = `熱量狀態（${d}）`;
      dayTotalEl.textContent = status.total;

      if (!status.limit) {
        dailyLimitEl.textContent = "—";
        overWarnEl.textContent = "請先到「個人設定」填寫身高、體重、年齡、性別與運動量，系統才能計算建議熱量。";
        overWarnEl.style.color = "#4d3900";
        overWarnEl.style.fontWeight = "600";
        return;
      }

      dailyLimitEl.textContent = status.limit;

      if (status.over) {
        overWarnEl.textContent = `⚠ ${d} 熱量已超過建議攝取量（+${status.overBy} kcal），仍可繼續新增紀錄。`;
        overWarnEl.style.color = "red";
        overWarnEl.style.fontWeight = "800";
      } else {
        overWarnEl.textContent = `✔ ${d} 仍在建議攝取範圍內`;
        overWarnEl.style.color = "#7a8f4e";
        overWarnEl.style.fontWeight = "800";
      }
    }

    // 初次渲染
    renderStatusBySelectedDate();

    // ✅ 日期改變就更新上方狀態
    dateEl.addEventListener("change", renderStatusBySelectedDate);

    // 新增照片
    btnPhoto.addEventListener("click", () => photoInput.click());

    photoInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        selectedPhoto = reader.result;
        msg.textContent = "📸 已選擇照片（將於新增時一併儲存）";
      };
      reader.readAsDataURL(file);
    });

    // 重新輸入
    btnReset.addEventListener("click", () => {
      food.value = "";
      cal.value = "";
      selectedPhoto = null;
      photoInput.value = "";
      msg.textContent = "🔄 已清空欄位";
    });

    // 新增
    btnAdd.addEventListener("click", () => {
      const d = dateEl.value;
      const f = food.value.trim();
      const c = cal.value;

      if (!d) { msg.textContent = "請選擇日期"; return; }
      if (!f) { msg.textContent = "請輸入食物名稱"; return; }
      if (!c) { msg.textContent = "請輸入熱量"; return; }

      window.App.addLog(meal.value, f, c, selectedPhoto, d);

      msg.textContent = selectedPhoto ? "✅ 已新增紀錄（含照片）" : "✅ 已新增紀錄";

      // 清空欄位
      food.value = "";
      cal.value = "";
      selectedPhoto = null;
      photoInput.value = "";

      // 更新狀態（可留著，避免跳轉前畫面沒更新）
      renderStatusBySelectedDate();

      // ✅ 新增完直接跳到「今日統計與建議」
      // 如果你想讓訊息顯示一下再跳，可把 200 改成 600
      setTimeout(() => {
        location.href = "stats.html";
      }, 200);
    });
  </script>
</body>
</html>
