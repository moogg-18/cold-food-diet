<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä»Šæ—¥çµ±è¨ˆèˆ‡å»ºè­°</title>
  <link rel="stylesheet" href="style.css?v=130" />
</head>

<body>
  <header class="topbar">
    <h1>ğŸ“Š ä»Šæ—¥çµ±è¨ˆèˆ‡å»ºè­°</h1>
    <p class="sub"><a class="link" href="index.html">â† å›é¦–é </a></p>
  </header>

  <main class="container">

    <!-- ä»Šæ—¥æ‘˜è¦ -->
    <section class="panel">
      <h2>ä»Šæ—¥æ‘˜è¦</h2>

      <div class="grid">
        <div class="metric">
          <div class="label">ä»Šæ—¥ç¸½ç†±é‡</div>
          <div class="value" id="total">0</div>
          <div class="hint">kcal</div>
        </div>

        <div class="metric">
          <div class="label">å»ºè­°æ”å–é‡</div>
          <div class="value" id="limit">â€”</div>
          <div class="hint">kcal</div>
        </div>

        <div class="metric">
          <div class="label">å†·æ€§é£Ÿç‰©æ¬¡æ•¸</div>
          <div class="value" id="cold">0</div>
          <div class="hint">æ¬¡</div>
        </div>

        <div class="metric">
          <div class="label">ç†±é‡ç‹€æ…‹</div>
          <div class="value" id="statusText">â€”</div>
          <div class="hint" id="statusHint"></div>
        </div>
      </div>

      <p class="note" id="warn">â€”</p>
      <p class="note" id="tip">â€”</p>
    </section>

    <!-- âœ… ä»Šæ—¥é£Ÿç‰©æ”å–ç´°é …ï¼ˆå«åˆªé™¤ï¼‰ -->
    <section class="panel food-detail-panel">
      <h2>ä»Šæ—¥é£Ÿç‰©æ”å–ç´°é …</h2>

      <div class="table-wrapper">
        <table class="food-table">
          <thead>
            <tr>
              <th>é¤åˆ¥</th>
              <th>é£Ÿç‰©åç¨±</th>
              <th>ç†±é‡ (kcal)</th>
              <th>æ˜¯å¦ç‚ºå†·æ€§é£Ÿç‰©</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="foodTableBody">
            <tr class="empty">
              <td colspan="5">å°šæœªæ–°å¢ä»»ä½•é£Ÿç‰©ç´€éŒ„</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- å¿«æ·å…¥å£ -->
    <section class="panel">
      <h2>å¿«æ·å…¥å£</h2>
      <a class="card" href="log.html">ğŸ± ç¹¼çºŒæ–°å¢ä¸‰é¤ç´€éŒ„</a>
      <a class="card" href="profile.html">ğŸ‘¤ å€‹äººè¨­å®š</a>
    </section>

  </main>

  <script src="app.js"></script>
  <script>
    const totalEl = document.getElementById("total");
    const coldEl = document.getElementById("cold");
    const tipEl = document.getElementById("tip");
    const limitEl = document.getElementById("limit");
    const statusTextEl = document.getElementById("statusText");
    const statusHintEl = document.getElementById("statusHint");
    const warnEl = document.getElementById("warn");
    const tbody = document.getElementById("foodTableBody");

    function renderSummary() {
      const s = window.App.getTodayStatus(); // ä½ åŸæœ¬çš„çµ±è¨ˆå‡½å¼
      totalEl.textContent = s.total;
      coldEl.textContent = s.coldCount;
      tipEl.textContent = "ğŸ’¡ å»ºè­°ï¼š" + s.tip;

      if (!s.limit) {
        limitEl.textContent = "â€”";
        statusTextEl.textContent = "æœªè¨­å®š";
        statusHintEl.textContent = "";
        warnEl.textContent =
          "è«‹å…ˆåˆ°ã€Œå€‹äººè¨­å®šã€å¡«å¯«èº«é«˜ã€é«”é‡ã€å¹´é½¡ã€æ€§åˆ¥èˆ‡é‹å‹•é‡ï¼Œç³»çµ±æ‰èƒ½è¨ˆç®—å»ºè­°ç†±é‡ã€‚";
        warnEl.style.color = "#4d3900";
        warnEl.style.fontWeight = "600";
      } else {
        limitEl.textContent = s.limit;

        if (s.over) {
          statusTextEl.textContent = "è¶…æ¨™";
          statusHintEl.textContent = `+${s.overBy} kcal`;
          warnEl.textContent =
            `âš  ä»Šæ—¥ç†±é‡å·²è¶…éå»ºè­°æ”å–é‡ï¼ˆ+${s.overBy} kcalï¼‰ï¼Œå»ºè­°ä¸‹é¤é™ä½æ²¹ç³–æˆ–å¢åŠ è”¬èœ/è›‹ç™½è³ªæ¯”ä¾‹ã€‚`;
          warnEl.style.color = "red";
          warnEl.style.fontWeight = "800";
        } else {
          statusTextEl.textContent = "æ­£å¸¸";
          statusHintEl.textContent = "åœ¨ç¯„åœå…§";
          warnEl.textContent =
            "âœ” ç›®å‰ä»åœ¨å»ºè­°æ”å–ç¯„åœå…§ï¼ŒæŒçºŒä¿æŒå‡è¡¡é£²é£Ÿï¼";
          warnEl.style.color = "#7a8f4e";
          warnEl.style.fontWeight = "800";
        }
      }
    }

    /* ====== ä»Šæ—¥é£Ÿç‰©è¡¨æ ¼ï¼šè®€å–ï¼ˆä¿åº•ï¼‰ ====== */
    function getLogsByDateSafe(d) {
      if (window.App && typeof window.App.getLogsByDate === "function") {
        return window.App.getLogsByDate(d) || [];
      }

      const tryKeys = ["logs", "foodLogs", "mealLogs", "dietLogs"];
      for (const k of tryKeys) {
        const raw = localStorage.getItem(k);
        if (!raw) continue;
        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr)) {
            return arr.filter(x => (x.date || x.d || x.day) === d);
          }
        } catch (_) {}
      }
      return [];
    }

    /* ====== åˆªé™¤ï¼ˆå„ªå…ˆç”¨ Appï¼Œæ²’æœ‰å°± localStorage ä¿åº•ï¼‰ ====== */
    function deleteLogSafe(log) {
      // 1) è‹¥ app.js æœ‰æä¾›åˆªé™¤ APIï¼šå„ªå…ˆç”¨
      if (window.App && typeof window.App.deleteLog === "function") {
        window.App.deleteLog(log);
        return true;
      }
      if (window.App && typeof window.App.removeLog === "function") {
        window.App.removeLog(log);
        return true;
      }

      // 2) ä¿åº•ï¼šå¾ localStorage å¸¸è¦‹ key åˆªé™¤ã€Œç¬¬ä¸€ç­†ç¬¦åˆã€çš„ç´€éŒ„
      const tryKeys = ["logs", "foodLogs", "mealLogs", "dietLogs"];
      const d = log.date || log.d || log.day;

      for (const k of tryKeys) {
        const raw = localStorage.getItem(k);
        if (!raw) continue;

        try {
          const arr = JSON.parse(raw);
          if (!Array.isArray(arr)) continue;

          const idx = arr.findIndex(x => {
            const xd = x.date || x.d || x.day;

            // ç”¨ã€Œå¤šæ¬„ä½æ¯”å°ã€é¿å…åˆªéŒ¯ï¼šæ—¥æœŸ + é¤åˆ¥ + åç¨± + ç†±é‡ + (å¯é¸) id/ts
            const sameCore =
              xd === d &&
              (x.meal || x.type) === (log.meal || log.type) &&
              (x.food || x.name) === (log.food || log.name) &&
              String(x.cal || x.kcal || x.calories) === String(log.cal || log.kcal || log.calories);

            const idKey = x.id || x.ts || x.time || x.createdAt;
            const logIdKey = log.id || log.ts || log.time || log.createdAt;

            // è‹¥æœ‰ id/ts å°±å†åŠ å¼·æ¯”å°
            if (idKey != null && logIdKey != null) {
              return sameCore && String(idKey) === String(logIdKey);
            }
            return sameCore;
          });

          if (idx >= 0) {
            arr.splice(idx, 1);
            localStorage.setItem(k, JSON.stringify(arr));
            return true;
          }
        } catch (_) {}
      }
      return false;
    }

    function makeRowKey(item) {
      // ç”¨ id/ts å„ªå…ˆï¼›æ²’æœ‰å°±ç”¨æ ¸å¿ƒæ¬„ä½æ‹¼ key
      const d = item.date || item.d || item.day || "";
      const m = item.meal || item.type || "";
      const f = item.food || item.name || "";
      const c = item.cal || item.kcal || item.calories || "";
      const id = item.id || item.ts || item.time || item.createdAt || "";
      return `${d}||${m}||${f}||${c}||${id}`;
    }

    function renderFoodTableToday() {
      const today = window.App.todayISO();
      const logs = getLogsByDateSafe(today);

      if (!logs || logs.length === 0) {
        tbody.innerHTML = `
          <tr class="empty">
            <td colspan="5">å°šæœªæ–°å¢ä»»ä½•é£Ÿç‰©ç´€éŒ„</td>
          </tr>`;
        return;
      }

      tbody.innerHTML = logs.map(item => {
        const meal = item.meal || "â€”";
        const food = item.food || item.name || "â€”";
        const kcal = item.cal || item.kcal || item.calories || "â€”";
        const cold =
          item.isCold === true ? "æ˜¯" :
          item.isCold === false ? "å¦" :
          "æœªåˆ¤å®š";

        const rowKey = makeRowKey(item);
        // æŠŠæ•´å€‹ item å£“æˆ data-jsonï¼Œåˆªé™¤æ™‚å–å›ä¾†æ¯”å°/åˆªé™¤
        const safeJson = encodeURIComponent(JSON.stringify(item));

        return `
          <tr>
            <td>${meal}</td>
            <td>${food}</td>
            <td>${kcal}</td>
            <td>${cold}</td>
            <td>
              <button class="btn btn-outline btn-del"
                type="button"
                data-rowkey="${rowKey}"
                data-json="${safeJson}"
              >åˆªé™¤</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    // âœ… äº‹ä»¶å§”æ´¾ï¼šé»åˆªé™¤
    tbody.addEventListener("click", (e) => {
      const btn = e.target.closest(".btn-del");
      if (!btn) return;

      const ok = confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ");
      if (!ok) return;

      try {
        const item = JSON.parse(decodeURIComponent(btn.dataset.json || ""));
        const deleted = deleteLogSafe(item);

        if (!deleted) {
          alert("åˆªé™¤å¤±æ•—ï¼šæ‰¾ä¸åˆ°å°æ‡‰ç´€éŒ„ï¼ˆå¯èƒ½ app.js å­˜çš„ key ä¸åŒï¼‰ã€‚");
          return;
        }

        // âœ… åˆªé™¤å¾Œï¼šåŒæ­¥åˆ·æ–°è¡¨æ ¼ + ä»Šæ—¥æ‘˜è¦
        renderFoodTableToday();
        renderSummary();
      } catch (err) {
        alert("åˆªé™¤å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤");
      }
    });

    // åˆæ¬¡é€²å…¥é é¢ï¼šæ¸²æŸ“æ‘˜è¦ + è¡¨æ ¼
    renderSummary();
    renderFoodTableToday();
  </script>
</body>
</html>
